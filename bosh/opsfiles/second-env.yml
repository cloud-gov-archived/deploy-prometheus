# Add 2ndenv prometheus
- type: replace
  path: /instance_groups/-
  value:
    name: prometheus-((2ndenv))
    instances: 1
    vm_type: ((environment))-prometheus-large
    persistent_disk_type: ((environment))-prometheus-large
    stemcell: default
    azs: ((azs))
    networks:
    - name: ((environment))-monitoring
    env:
      persistent_disk_fs: xfs
    jobs:
    - name: prometheus2
      release: prometheus
      properties:
        prometheus:
          external_labels:
            secondenv: prometheus-((2ndenv))
          scrape_configs:
          - job_name: prometheus
            static_configs:
            - targets:
              - localhost:9090
          - job_name: bosh
            scrape_interval: 1m
            scrape_timeout: 1m
            static_configs:
            - targets:
              - localhost:9190
          - job_name: concourse
            file_sd_configs:
            - files:
              - /var/vcap/store/bosh_exporter/bosh_target_groups.json
            relabel_configs:
            - source_labels: [__meta_bosh_job_process_name]
              regex: atc
              action: keep
            - source_labels: [__address__]
              regex: "(.*)"
              target_label: __address__
              replacement: "${1}:9110"
            - source_labels: [__meta_bosh_deployment]
              regex: "(.*)"
              target_label: bosh_deployment
              replacement: "$1"
          - job_name: node
            file_sd_configs:
            - files:
              - /var/vcap/store/bosh_exporter/bosh_target_groups.json
            relabel_configs:
            - source_labels: [__meta_bosh_job_process_name]
              regex: node_exporter
              action: keep
            - source_labels: [__address__]
              regex: "(.*)"
              target_label: __address__
              replacement: "${1}:9100"
    - name: bosh_exporter
      release: prometheus
      properties:
        bosh_exporter:
          bosh:
            url: ((bosh2-url))
            ca_cert: ((bosh2-ca-cert))
            uaa:
              url: ((bosh2-url)):8443
              client_id: ((bosh2-client-id))
              client_secret: ((bosh2-client-secret))
          metrics:
            environment: ((2ndenv))
    - name: cf_exporter
      release: prometheus
      properties:
        cf_exporter:
          cf:
            api_url: https://api.((2nddomain))
            client_id: ((cf-exporter2-client-id))
            client_secret: ((cf-exporter2-client-secret))
            deployment_name: cf-((environment))
          metrics:
            environment: ((environment))
    - name: firehose_exporter
      release: prometheus
      properties:
        firehose_exporter:
          uaa:
            url: https://login.((2nddomain))
            client_id: ((firehose2-client-id))
            client_secret: ((firehose2-client-secret))
          doppler:
            subscription_id: prometheus
          metrics:
            environment: ((environment))
          logging:
            url: wss://doppler.((2nddomain)):443
            use_legacy_firehose: true

# add bosh-dns alias to save on rtc-dns config

- type: replace
  path: /addons?/-
  value:
    name: bosh-dns-aliases
    jobs:
    - name: bosh-dns-aliases
      release: bosh-dns-aliases
      properties:
        aliases:
        - domain: prometheus-((2ndenv)).service.monitoring
          targets:
          - query: '*'
            instance_group: prometheus-((2ndenv))
            deployment: prometheus-((environment))
            network: ((environment))-monitoring
            domain: bosh

# add in bosh-dns-alias release
- type: replace
  path: /releases/name=bosh-dns-aliases?
  value:
    name: bosh-dns-aliases
    version: latest



# Scrape 2ndenv prometheus via federation
- type: replace
  path: /instance_groups/name=prometheus/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: secondenv
    honor_labels: true
    metrics_path: secondenv
    params:
      match[]:
      - '{__name__=~"bosh_.*"}'
      - '{__name__=~"node_.*"}'
      - '{__name__=~"nessus_.*"}'
      - '{__name__=~"concourse.*"}'
    static_configs:
    - targets:
      #- prometheus-((2ndenv)).service.cf.internal:9090
      - prometheus-((2ndenv)).service.monitoring:9090

# instance types.
- type: replace
  path: /instance_groups/name=prometheus-((2ndenv))/vm_type
  value: m5.large
